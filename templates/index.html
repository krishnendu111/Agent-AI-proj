<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Financial AI Analyst</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <style>
        /* Modern Dark Theme */
        body { background-color: #0f172a; color: #e2e8f0; font-family: sans-serif; }
        .card { background-color: #1e293b; border: none; border-radius: 15px; }
        #output-container { background-color: #1e293b; padding: 25px; border-radius: 15px; margin-top: 20px; display: none; }
        
        /* Table Styling for the Report */
        table { width: 100%; color: #fff; margin-bottom: 1rem; border: 1px solid #475569; }
        table th, table td { padding: 12px; border: 1px solid #475569; }
        table th { background-color: #3b82f6; }

        /* Loader Animation */
        .loader { border: 4px solid #f3f3f3; border-top: 4px solid #3b82f6; border-radius: 50%; width: 30px; height: 30px; animation: spin 1s linear infinite; display: none; margin: 10px auto; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        /* Print styling to ensure PDF looks good */
        @media print {
            body { background-color: white !important; color: black !important; }
            .no-print { display: none !important; }
            #output-container { display: block !important; background-color: white !important; }
            table th { background-color: #eee !important; color: black !important; }
        }
    </style>
</head>
<body>
    <div class="container py-5">
        <div class="row justify-content-center">
            <div class="col-md-9">
                <div class="text-center no-print">
                    <h1 class="mb-4">ðŸ“Š AI Financial Analyst</h1>
                    <div class="card p-4 mb-4">
                        <div class="input-group">
                            <input type="text" id="companyInput" class="form-control" placeholder="Enter Company or Ticker...">
                            <button class="btn btn-primary" onclick="analyzeStock()">Search</button>
                        </div>
                        <div class="loader" id="loader"></div>
                    </div>
                </div>

                <div id="output-container">
                    <div class="d-flex justify-content-between align-items-center mb-3 no-print">
                        <h4 class="m-0">Analysis Results</h4>
                        <button class="btn btn-success" onclick="triggerSaveAs()">Save as PDF</button>
                    </div>
                    <hr class="no-print">
                    <div id="stockOutput"></div>
                </div>
            </div>
        </div>
    </div>

    <script>
        async function analyzeStock() {
            const company = document.getElementById('companyInput').value;
            const loader = document.getElementById('loader');
            const outputDiv = document.getElementById('stockOutput');
            const container = document.getElementById('output-container');

            if (!company) return alert("Please enter a stock name");

            // UI State
            loader.style.display = 'block';
            container.style.display = 'block';
            outputDiv.innerHTML = "Consulting OpenAI and Market Data...";

            // Timeout controller for the browser side (30 seconds)
            const controller = new AbortController();
            const timeoutId = setTimeout(() => controller.abort(), 30000);

            try {
                const formData = new FormData();
                formData.append('company', company);

                const response = await fetch('/get_stock', { 
                    method: 'POST', 
                    body: formData,
                    signal: controller.signal 
                });

                const data = await response.json();
                clearTimeout(timeoutId);
                loader.style.display = 'none';

                if (data.error) {
                    outputDiv.innerHTML = `<div class="alert alert-danger">${data.error}</div>`;
                } else {
                    outputDiv.innerHTML = data.output;
                }
            } catch (err) {
                loader.style.display = 'none';
                if (err.name === 'AbortError') {
                    outputDiv.innerHTML = `<div class="alert alert-warning">Request timed out (30s). Please try your search again.</div>`;
                } else {
                    outputDiv.innerHTML = "An error occurred while connecting to the server.";
                }
            }
        }

        function triggerSaveAs() {
            // This opens the system print dialog.
            // User can select "Save as PDF" in the destination dropdown
            // and will be prompted to choose a file name and location.
            window.print();
        }
    </script>
</body>
</html>